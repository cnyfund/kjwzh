<?php require_once("epay.config.php"); require_once("lib/epay_notify.class.php"); require_once $_SERVER['DOCUMENT_ROOT'] . '/include/conn.php'; $alipayNotify = new AlipayNotify($alipay_config); $verify_result = $alipayNotify->verifyNotify();  if($verify_result) { $out_trade_no = $_GET['out_trade_no']; $trade_no = $_GET['trade_no']; $trade_status = $_GET['trade_status']; $type = $_GET['type']; $money= $_GET['money']; if ($_GET['trade_status'] == 'TRADE_SUCCESS') { $h_money=number_format($money,2,".",""); $orderid=$out_trade_no; $sql = "select * from `blypay_order` where `orderid`='".$orderid."'  and `amout`='".$h_money."' and `state`='0' LIMIT 1"; $rs = $db->get_one($sql); if($rs){  $h_bank=$rs["bank"]; $h_userName=$rs["username"]; $sql="insert into h_recharge (h_userName,h_money,h_bank,h_addTime,h_state,h_actIP,h_isReturn) values ('".$h_userName."','".$h_money."','".$h_bank."','".date('Y-m-d H:i:s')."','1','".$_SERVER["REMOTE_ADDR"]."','1')"; $result = $db->query($sql); if($result){ }   $sql = "update `h_member` set "; $sql .= "h_point2 = h_point2 + {$h_money} "; $sql .= "where h_userName = '" . $h_userName . "' "; $db->query($sql);   $h_reply="在线支付"; $sql = "insert into `h_log_point2` set "; $sql .= "h_userName = '" . $h_userName . "', "; $sql .= "h_price = '" . $h_money . "', "; $sql .= "h_type = '充值', "; $sql .= "h_about = '{$h_reply}', "; $sql .= "h_addTime = '" . date('Y-m-d H:i:s') . "', "; $sql .= "h_actIP = '" . $_SERVER["REMOTE_ADDR"] . "' "; $db->query($sql);  $sql = "update `blypay_order` set state='1' where `orderid`='".$orderid."'  and `amout`='".$h_money."' and `state`='0'"; $db->query($sql);  }else{  }  } echo "success"; } else { echo "fail"; } ?>